# DATA_API --- Land Price Index Sync Services

이 문서는 **토지가격지수 동기화 서비스 레이어**의 핵심 기능인\
`FULL 동기화` 와 `UPDATE(증분) 동기화`의 동작 구조와 실제 소스 흐름을
설명한다.

본 문서는 실행 가이드가 아닌 **설계 & 내부 로직 설명 문서**이다.

------------------------------------------------------------------------

# 1. FULL Sync

## 1-1. 목적

-   모든 지역 전체 재수집
-   초기 DB 구축 및 전면 재동기화용

## 1-2. 처리 대상

-   `region_base` 전체 지역
-   요청 파라미터(`fromYm ~ toYm`) 전체 기간

## 1-3. 흐름

1.  DB Connection 획득 (`getConn`)
2.  전체 지역 조회 (`loadAllRegions`)
3.  `PID 20` SYNC_START 로그
4.  각 지역 반복
    -   외부 API 호출
    -   월별 시계열 변환
    -   `sp_merge_land_price_index` 병합 실행
5.  지역 오류 발생 시 `PID 21` 로그
6.  전체 종료 시 요약 생성
7.  `PID 90` SYNC_DONE 로그

## 1-4. 시계열 처리

외부 API 응답을

``` json
{ "ym", "index_value", "change_rate" }
```

형태 배열로 변환 후 병합 프로시저 호출

------------------------------------------------------------------------

# 2. UPDATE Sync

## 2-1. 목적

-   매월 신규 데이터만 수집
-   네트워크 및 DB 부하 최소화

## 2-2. 핵심 구조

1.  모든 지역별 DB 최종 월 조회 (`loadAllLastYm`)
2.  각 지역의 다음 월 산출 (`nextMonth`)
3.  실제 요청 시작 월 계산

```{=html}
<!-- -->
```
    effectiveFromYm = max(fromYm, nextMonth(lastYm))

-   이미 최신이면 API 호출 생략

------------------------------------------------------------------------

## 2-3. 흐름

1.  DB Connection 획득
2.  전체 지역 조회
3.  전체 지역 lastYm 일괄 조회
4.  `PID 20` SYNC_START
5.  각 지역 루프
    -   effectiveFromYm 계산
    -   외부 API 호출
    -   시계열 생성
    -   병합 저장
6.  지역 오류 시 `PID 21`
7.  요약 생성
8.  `PID 90` 완료 로그

## 2-4. 응답 차이

| 항목 | FULL | UPDATE |
|------|------|--------|
| 모든 기간 처리 | ✔ | ✖ |
| 증분 요청 | ✖ | ✔ |
| `errorRegions` 응답 포함 | ✔ | ✖ |
| 증분 처리 최적화 | 없음 | 있음 |

------------------------------------------------------------------------

# 3. FULL vs UPDATE 비교

| 항목 | FULL | UPDATE |
|------|------|--------|
| 목적 | 전면 수집 | 증분 반영 |
| 처리 기간 | `fromYm ~ toYm` 전체 | 각 지역별 미수집 월만 |
| `lastYm` 사용 | 없음 | 있음 |
| 시계열 처리 위치 | `syncRegion` | `syncUpdate` 내부 |
| 리소스 부하 | 큼 | 작음 |
| 운영 사용처 | 초기 / 재동기화 | 정기 배치 |

------------------------------------------------------------------------

# END
