# DATA_API --- Global Middleware Design (`src/middlewares`)

이 문서는 DATA_API 서버에서 사용하는 **전역 미들웨어 레이어의 역할과
실제 소스 흐름**을 설명한다.

실행·점검 명령은 ROOT README에서 관리한다.\
본 문서는 **setup.js / notFound.js 설계 의도와 실제 동작 순서** 중심의
설계 설명 문서이다.

------------------------------------------------------------------------

------------------------------------------------------------------------

## 1. Middleware 위치

``` text
src/middlewares/
 ├── setup.js
 └── notFound.js
```

전역 미들웨어는 **라우터 진입 전·후 파이프라인**을 관리하는 공통
계층으로:

    Request
      ↓
    setup.js   (공통 초기화)
      ↓
    router
      ↓
    handlers/services
      ↓
    notFound.js (매칭 실패 보정)

------------------------------------------------------------------------

------------------------------------------------------------------------

## 2. setup.js --- 요청 초기화 미들웨어

### 역할

`setup.js` 는 모든 요청의 **전처리 단계**를 담당한다.

#### 주요 책임

1.  **Access Logging**
    -   `morgan('dev')` 사용
    -   모든 HTTP 요청에 대해 access 로그 출력
2.  **Request Body 파싱**
    -   `express.json()` 로 JSON 자동 파싱
    -   handler/service 에서는 raw parse 불필요
3.  **Cookie 파싱**
    -   `cookie-parser` 적용
    -   JWT 토큰, 세션 확장 시 대응 여지 확보

------------------------------------------------------------------------

### 구조 예시

``` js
app.use(morgan('dev'));
app.use(express.json());
app.use(cookieParser());
```

모든 엔드포인트 진입 전에 적용된다.

------------------------------------------------------------------------

------------------------------------------------------------------------

## 3. setup.js 의 설계 의도

### ✅ Cross-Cutting Concern 분리

-   요청 처리 파이프라인의 핵심 로직은
    -   routes
    -   handlers
    -   services
-   공통 관심사는 middleware 레이어에서 흡수

------------------------------------------------------------------------

### ✅ Handler 단순화

body parsing, cookie 해석, access logging 을 handler/service 에서 **전혀
재구현할 필요 없음**

------------------------------------------------------------------------

### ✅ 운영 안정성 확보

전처리 파이프라인 일원화를 통해:

-   누락 로그 방지
-   파싱 예외 감소
-   요청 메타데이터 관리 단순화

------------------------------------------------------------------------

------------------------------------------------------------------------

## 4. notFound.js --- 미매칭 요청 처리

### 역할

라우팅되지 않은 요청을 **공통 포맷 로깅 + 404 응답 규칙**으로 정리한다.

------------------------------------------------------------------------

### 구조

``` js
const ret = my_lib.get_req_url(req);
console.error("[ERROR-404]", ret);
return res.status(404).json(ret);
```

#### 처리 절차

1.  `get_req_url(req)`

    -   소스 IP
    -   소스 PORT
    -   요청 URL
    -   기본 CID 정보 추출

2.  공통 로그 포맷(SX_RET) 생성

3.  콘솔 로깅

4.  `HTTP 404` 응답 반환

------------------------------------------------------------------------

------------------------------------------------------------------------

## 5. notFound.js 설계 의도

### ✅ 일관된 로그 수집

404 또한 **일반적인 요청 실패와 동일한 구조의 로그로 남김**

운영 중:

-   불법 스캐닝 요청
-   잘못된 프론트 요청
-   API Endpoint 오타

을 **정상적 데이터 흐름과 동일한 포맷으로 추적 가능**

------------------------------------------------------------------------

### ✅ Fragment 로그 방지

단순 텍스트:

``` text
404 Not Found: /invalid-path
```

대신:

``` json
{
  "sid":"100",
  "pid":0,
  "cid":"...",
  "buffer":{
     "src_ip":"...",
     "dest_url_path":"/invalid-path"
  }
}
```

로 정규화된 상태 정보 확보

------------------------------------------------------------------------

------------------------------------------------------------------------

## 6. 전역 Middleware 전체 흐름

    Client
       ↓
    [morgan access log]
       ↓
    [express.json body parse]
       ↓
    [cookie-parser]
       ↓
    Router
       ↓
    Handler / Service
       ↓
    정상 응답
     OR
    라우팅 실패
       ↓
    notFound.js
       ↓
    404 + 공통로그

------------------------------------------------------------------------

------------------------------------------------------------------------

## 7. Logging 연계

### setup.js

-   Access 단 로그는 `morgan` 에 의해 출력됨
-   Application Log 는 사용하지 않음

------------------------------------------------------------------------

### notFound.js

-   `my_lib.get_req_url()` 기반 SPR 로그 생성
-   로그 스펙:
    -   `sid = LOG_ENV.SID_API`
    -   `pid = 0`
    -   `cid = timestamp`
    -   `value1 = 0`
    -   `value2 = 0`

> 동기화 / 통계 API 로그와 동일한 규격

------------------------------------------------------------------------

------------------------------------------------------------------------

## 8. 설계 핵심 요약

  항목                 목적
  -------------------- -----------------------
  setup.js             요청 전처리 단일 계층
  morgan               Access 로그 분리
  body / cookie 파서   핸들러 단 로직 단순화
  notFound.js          미매칭 요청 공통 처리
  공통 sx_ret 포맷     로그 일관성 보장

------------------------------------------------------------------------

### ✅ 결과 구조

Middleware 레이어는:

-   **실제 비즈니스 로직에 개입하지 않는다**
-   모든 요청을 "접근 준비 상태"로 만들고
-   "잘못된 요청도 정규화된 로그로 정리"하는 **안전 계층** 역할을
    수행한다

------------------------------------------------------------------------

# END
